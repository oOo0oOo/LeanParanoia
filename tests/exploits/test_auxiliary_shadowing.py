import pytest


@pytest.mark.exploit
@pytest.mark.xfail(reason="Replay detects 2/5 auxiliary exploits")
def test_matcher_shadowing(verifier):
    """foo uses bar.match_1 auxiliary"""
    result = verifier.verify_theorem(
        "LeanTestProject.AuxiliaryShadowing.MatcherShadowing", "test1"
    )
    assert not result.success


@pytest.mark.exploit
@pytest.mark.xfail(reason="Replay detects 2/5 auxiliary exploits")
def test_proof_shadowing(verifier):
    """foo calls bar.match_1 directly"""
    result = verifier.verify_theorem(
        "LeanTestProject.AuxiliaryShadowing.ProofShadowing", "exploit"
    )
    assert not result.success


@pytest.mark.exploit
@pytest.mark.xfail(reason="Replay detects 2/5 auxiliary exploits")
def test_private_shadowing(verifier):
    """foo uses bar._sunfold auxiliary"""
    result = verifier.verify_theorem(
        "LeanTestProject.AuxiliaryShadowing.PrivateShadowing", "exploit"
    )
    assert not result.success


@pytest.mark.exploit
def test_theorem_shadowing(verifier):
    """Theorem type uses bar.match_1 - caught by Replay"""
    result = verifier.verify_theorem(
        "LeanTestProject.AuxiliaryShadowing.TheoremShadowing", "exploit"
    )
    assert not result.success
    assert "Replay" in result.failed_tests


@pytest.mark.exploit
def test_type_signature_shadowing(verifier):
    """Type signature uses bar.match_1 - caught by Replay"""
    result = verifier.verify_theorem(
        "LeanTestProject.AuxiliaryShadowing.TypeSignature", "exploit"
    )
    assert not result.success
    assert "Replay" in result.failed_tests
