"""
Tests for constructor/recursor manipulation exploit detection.
"""

import pytest


@pytest.mark.exploit
def test_manual_constructor(verifier):
    """Test manual constructor manipulation detection"""
    result = verifier.verify_theorem(
        "LeanTestProject.Constructors.Manual", "exploit_theorem"
    )

    assert not result.success
    assert "ConstructorIntegrity" in result.failed_tests
    assert "RecursorIntegrity" in result.failed_tests


@pytest.mark.exploit
def test_constructor_integrity_detects_manual_additions(verifier):
    """Expect constructor integrity check to flag rewritten constructors"""
    result = verifier.verify_theorem(
        "LeanTestProject.Constructors.Manual", "exploit_theorem"
    )

    assert not result.success
    assert "ConstructorIntegrity" in result.failed_tests


@pytest.mark.exploit
def test_recursor_integrity_detects_missing_recursor(verifier):
    """Expect recursor integrity check to flag missing recursors"""
    result = verifier.verify_theorem(
        "LeanTestProject.Constructors.Manual", "exploit_theorem"
    )

    assert not result.success
    assert "RecursorIntegrity" in result.failed_tests
