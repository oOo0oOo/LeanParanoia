"""
Tests for dangerous debug option detection.

These options can bypass kernel verification or replace proofs with sorry.
All are caught by existing LeanParanoia checks:
- EnvironmentReplay catches debug.skipKernelTC
- NoSorry catches debug.proofAsSorry, debug.byAsSorry, debug.terminalTacticsAsSorry
"""

import pytest


@pytest.mark.exploit
def test_skip_kernel_tc_documented(verifier, default_config):
    """debug.skipKernelTC would bypass kernel if set in lakefile, but
    setting it via set_option in source code doesn't help because elaboration
    happens first. This test uses an axiom to represent the exploit."""
    result = verifier.verify_theorem(
        "LeanTestProject.DebugOptions.SkipKernelTC",
        "exploit_theorem",
        config=dict(default_config),
    )

    assert not result.success
    # Caught by AxiomWhitelist (we use axiom since set_option doesn't help)
    assert "AxiomWhitelist" in result.failed_tests


@pytest.mark.exploit
def test_proof_as_sorry_rejected(verifier, default_config):
    """debug.proofAsSorry replaces proofs with sorry - caught by NoSorry."""
    result = verifier.verify_theorem(
        "LeanTestProject.DebugOptions.ProofAsSorry",
        "exploit_theorem",
        config=dict(default_config),
    )

    assert not result.success
    assert "NoSorry" in result.failed_tests


@pytest.mark.exploit
def test_by_as_sorry_rejected(verifier, default_config):
    """debug.byAsSorry replaces tactic blocks with sorry - caught by NoSorry."""
    result = verifier.verify_theorem(
        "LeanTestProject.DebugOptions.ByAsSorry",
        "exploit_theorem",
        config=dict(default_config),
    )

    assert not result.success
    assert "NoSorry" in result.failed_tests


@pytest.mark.exploit
def test_terminal_tactics_as_sorry_rejected(verifier, default_config):
    """debug.terminalTacticsAsSorry replaces terminal tactics with sorry - caught by NoSorry."""
    result = verifier.verify_theorem(
        "LeanTestProject.DebugOptions.TerminalTacticsAsSorry",
        "exploit_theorem",
        config=dict(default_config),
    )

    assert not result.success
    assert "NoSorry" in result.failed_tests


@pytest.mark.exploit
def test_unsafe_reducibility_allowed(verifier, default_config):
    """allowUnsafeReducibility allows unsafe modifications but doesn't affect soundness."""
    result = verifier.verify_theorem(
        "LeanTestProject.DebugOptions.UnsafeReducibility",
        "exploit_theorem",
        config=dict(default_config),
    )

    # This should actually pass - it's a valid proof, just uses an option
    # that allows potentially confusing reducibility changes
    assert result.success
