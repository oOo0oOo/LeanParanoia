-- CSimp attribute with unsafe implementation replaces function at runtime
-- The exploit: @[csimp] + @[implemented_by] makes compiler use wrong impl
def correctAdd (n m : Nat) : Nat := n + m

unsafe def wrongAddImpl (n m : Nat) : Nat := n + m + 1

@[implemented_by wrongAddImpl]
def wrongAdd (n m : Nat) : Nat := n + m

@[csimp] theorem correctAdd_eq_wrongAdd : @correctAdd = @wrongAdd := rfl

-- At runtime, csimp+unsafe makes this return 3
axiom exploit_axiom : correctAdd 1 1 = 3

theorem exploit_theorem : 1 + 1 = 3 := exploit_axiom
